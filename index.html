<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1" />
  <title>Hayat Farms — Owners</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

  <style>
    :root{
      --aqua:#14c6c9;
      --aqua2:#0ea5a8;
      --card: rgba(255,255,255,.08);
      --stroke: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.68);
      --danger:#ff3b30;
      --shadow: 0 20px 70px rgba(0,0,0,.45);
      --radius: 22px;
      --font: -apple-system, BlinkMacSystemFont, "SF Pro Display","SF Pro Text", "Segoe UI", Roboto, Arial, sans-serif;
    }

    html, body { width:100%; overflow-x:hidden; }
    *{box-sizing:border-box}

    body{
      margin:0;
      font-family:var(--font);
      color:var(--text);
      min-height:100vh;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      background:
        radial-gradient(1100px 700px at 80% 10%, rgba(20,198,201,.22), transparent 55%),
        radial-gradient(900px 600px at 15% 85%, rgba(14,165,168,.20), transparent 55%),
        linear-gradient(180deg, #041215, #02090b);
      position:relative;
      overflow:hidden;
    }

    body::before{
      content:"HAYAT FARMS • HAYAT FARMS • HAYAT FARMS •";
      position:absolute;
      inset:-120px;
      font-weight:800;
      font-size:26px;
      letter-spacing:2px;
      opacity:.06;
      transform: rotate(-18deg);
      white-space:nowrap;
      display:flex;
      align-items:center;
      justify-content:center;
      pointer-events:none;
      color:#fff;
    }

    .wrap{
      width: min(980px, 100%);
      margin: 0 auto;
      display:grid;
      gap:14px;
    }

    .brand h1{ margin:0; font-size:22px; }
    .brand p{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.55; }

    .card{
      width:100%;
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      padding:16px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid{ grid-template-columns:1fr; }
    }

    .label{ font-size:12px; color:var(--muted); margin:0 0 8px 0; }
    input{
      width:100%;
      padding:14px 14px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color:var(--text);
      outline:none;
      font-size:15px;
    }
    input::placeholder{ color:rgba(255,255,255,.45) }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .btn{
      border:0;
      border-radius:16px;
      padding:12px 14px;
      font-weight:700;
      cursor:pointer;
      transition:.15s transform ease;
      user-select:none;
    }
    .btn:active{ transform:scale(.98) }
    .btn-primary{ background: linear-gradient(135deg, var(--aqua), var(--aqua2)); color:#001214; }
    .btn-ghost{ background: rgba(255,255,255,.10); color:var(--text); border:1px solid rgba(255,255,255,.14); }
    .btn-danger{ background: rgba(255,59,48,.14); color:#fff; border:1px solid rgba(255,59,48,.35); }

    .hint{ margin-top:10px; font-size:12px; color:var(--muted); line-height:1.55; }
    .status{ margin-top:10px; font-size:12px; color:var(--muted); }
    .status strong{ color:#fff; }

    .calWrap{
      padding:12px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      overflow:hidden;
    }

    /* Flatpickr */
    .flatpickr-calendar{
      background: transparent !important;
      box-shadow:none !important;
      border:0 !important;
      width:100% !important;
      max-width:100% !important;
    }
    .flatpickr-months .flatpickr-month{ color:#fff !important; }
    .flatpickr-current-month .flatpickr-monthDropdown-months,
    .flatpickr-current-month input.cur-year{
      color:#fff !important;
      background: transparent !important;
    }
    .flatpickr-weekdays, .flatpickr-days{ background: transparent !important; }
    .flatpickr-day{ border-radius:12px !important; color: rgba(255,255,255,.90) !important; }
    .flatpickr-day:hover{ background: rgba(20,198,201,.18) !important; border-color: transparent !important; }
    .flatpickr-day.selected{ background: var(--danger) !important; border-color: var(--danger) !important; color:#fff !important; }
    .flatpickr-day.today{ border-color: rgba(20,198,201,.55) !important; }

    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:12px; }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      background: rgba(255,255,255,.10);
      border:1px solid rgba(255,255,255,.14);
      color:#fff;
    }

    .page{ display:none }
    .page.active{ display:block }

    .title2{ margin:0 0 10px 0; font-size:18px; }

    .confirmBox{
      border-radius:18px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      padding:14px;
      line-height:1.7;
      color:rgba(255,255,255,.88);
    }

    .okIcon{
      width:48px;height:48px;
      border-radius:16px;
      background: rgba(52,199,89,.16);
      border:1px solid rgba(52,199,89,.35);
      display:flex;align-items:center;justify-content:center;
      font-size:24px;
      margin-bottom:12px;
    }

    .footerRow{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }

    .tiny{ font-size:11px; color:rgba(255,255,255,.55); }

    .toggle{
      display:flex; align-items:center; gap:10px;
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      margin-top:12px;
    }
    .toggle input{ width:18px; height:18px; }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="brand">
      <h1>Hayat Farms — Owners</h1>
      <p>اختار الأيام المحجوزة من التقويم (بتصير أحمر) → التالي → تأكيد.</p>
    </div>

    <!-- PAGE 1 -->
    <div class="card page active" id="page1">
      <div class="grid">
        <div>
          <p class="label">كود المزرعة</p>
          <input id="farmCode" placeholder="اكتب كود المزرعة" autocomplete="off" />

          <div class="toggle">
            <input type="checkbox" id="noBookings">
            <label for="noBookings" style="color:rgba(255,255,255,.9);font-size:13px;">
              لا يوجد أي حجز حالياً (المزرعة فاضية بالكامل)
            </label>
          </div>

          <div class="hint">
            إذا ما في حجوزات، فعل خيار <strong>لا يوجد أي حجز</strong> واضغط <strong>التالي</strong>.
          </div>

          <div class="status" id="status1">الحالة: <strong>جاهز</strong></div>

          <div class="footerRow">
            <div class="row">
              <button class="btn btn-primary" id="toConfirm">التالي</button>
              <button class="btn btn-ghost" id="clearAll">مسح كل التواريخ</button>
            </div>
            <div class="tiny" id="selectedCount">0 يوم مختار</div>
          </div>

          <div class="chips" id="chips"></div>
        </div>

        <div>
          <p class="label">التقويم (اختيار أيام متعددة)</p>
          <div class="calWrap">
            <!-- نخلي الإدخال مخفي ونرسم التقويم داخل div لضمان ظهوره على الآيفون -->
            <input id="calendar" type="text" style="display:none;" />
            <div id="calendarInline"></div>
          </div>

          <div class="hint">
            التقويم ظاهر دائماً. اختار الأيام المحجوزة—كل يوم تختاره بصير أحمر. إذا ضغطت عليه مرة ثانية بينشال.
          </div>
        </div>
      </div>
    </div>

    <!-- PAGE 2 -->
    <div class="card page" id="page2">
      <h2 class="title2">تأكيد</h2>
      <div class="confirmBox" id="confirmText"></div>

      <div class="footerRow">
        <div class="row">
          <button class="btn btn-primary" id="confirmYes">تأكيد</button>
          <button class="btn btn-danger" id="confirmNo">تغيير</button>
        </div>
        <div class="tiny">سيتم إرسال إشعار رسمي بعد التأكيد.</div>
      </div>
    </div>

    <!-- PAGE 3 -->
    <div class="card page" id="page3">
      <div class="okIcon">✅</div>
      <h2 class="title2">تم</h2>
      <p style="margin:0;color:var(--muted);line-height:1.7">
        تم تسجيل التحديث.
      </p>

      <div class="footerRow">
        <div class="row">
          <button class="btn btn-primary" id="doneOk">تم</button>
          <button class="btn btn-ghost" id="doneChange">تغيير مواعيد الحجز</button>
        </div>
        <div class="tiny" id="doneSummary"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    // CONFIG (جاهزة)
    const BOT_TOKEN = "8366339729:AAETpHG82bSLlK7mhydBaJdSkcR50ACRn-M";
    const CHAT_ID   = "1780166982";

    const $ = (id) => document.getElementById(id);

    function showPage(n){
      ["page1","page2","page3"].forEach((p,i)=> $(p).classList.toggle("active", i === (n-1)));
      window.scrollTo({top:0, behavior:"smooth"});
    }

    function fmtISO(d){
      const y = d.getFullYear();
      const m = String(d.getMonth()+1).padStart(2,"0");
      const day = String(d.getDate()).padStart(2,"0");
      return `${y}-${m}-${day}`;
    }

    function sortDates(arr){ return [...arr].sort((a,b)=>a.getTime()-b.getTime()); }

    function renderChips(dates){
      const chips = $("chips");
      chips.innerHTML = "";
      const sorted = sortDates(dates);

      sorted.forEach(d=>{
        const chip = document.createElement("div");
        chip.className = "chip";
        chip.textContent = fmtISO(d);
        chips.appendChild(chip);
      });

      $("selectedCount").textContent = `${sorted.length} يوم مختار`;
      $("doneSummary").textContent = sorted.length
        ? `التواريخ: ${sorted.map(fmtISO).join("، ")}`
        : `لا يوجد حجوزات`;
    }

    function setStatus(text, strong){
      $("status1").innerHTML = `الحالة: <strong>${strong}</strong> — ${text}`;
    }

    async function sendTelegram(text){
      const url = `https://api.telegram.org/bot${encodeURIComponent(BOT_TOKEN)}/sendMessage`;
      const payload = { chat_id: CHAT_ID, text, disable_web_page_preview: true };

      const res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      if (!data || data.ok !== true) throw new Error("Telegram send failed");
      return data;
    }

    const state = { code:"", dates:[], noBookings:false };

    function loadSaved(){
      try{
        const raw = localStorage.getItem("hayat_farms_owner");
        if(!raw) return;
        const obj = JSON.parse(raw);
        state.code = typeof obj.code === "string" ? obj.code : "";
        state.noBookings = !!obj.noBookings;
        state.dates = Array.isArray(obj.dates) ? obj.dates.map(x=>new Date(x)).filter(d=>!isNaN(d)) : [];
      }catch{}
    }
    function save(){
      localStorage.setItem("hayat_farms_owner", JSON.stringify({
        code: state.code,
        noBookings: state.noBookings,
        dates: state.dates.map(d=>d.toISOString())
      }));
    }

    loadSaved();
    $("farmCode").value = state.code;
    $("noBookings").checked = state.noBookings;

    // التقويم: Multiple + inline داخل div (مضمون على iPhone)
    const fp = flatpickr("#calendar", {
      inline: true,
      appendTo: $("calendarInline"),
      mode: "multiple",
      dateFormat: "Y-m-d",
      disableMobile: true,
      defaultDate: state.dates,
      onChange: function(selectedDates){
        state.dates = selectedDates || [];
        if(state.dates.length) { state.noBookings = false; $("noBookings").checked = false; }
        save();
        renderChips(state.dates);
      }
    });

    renderChips(state.dates);

    $("farmCode").addEventListener("input", (e)=>{
      state.code = (e.target.value || "").trim();
      save();
    });

    $("noBookings").addEventListener("change", (e)=>{
      state.noBookings = !!e.target.checked;
      if(state.noBookings){
        fp.clear();
        state.dates = [];
        renderChips(state.dates);
        setStatus("تم اختيار: لا يوجد أي حجز.", "جاهز");
      }
      save();
    });

    $("clearAll").addEventListener("click", ()=>{
      fp.clear();
      state.dates = [];
      state.noBookings = false;
      $("noBookings").checked = false;
      save();
      renderChips(state.dates);
      setStatus("تم مسح جميع التواريخ.", "جاهز");
    });

    $("toConfirm").addEventListener("click", ()=>{
      state.code = ($("farmCode").value || "").trim();
      save();

      if(!state.code){
        setStatus("اكتب كود المزرعة أولاً.", "تنبيه");
        return;
      }

      if(!state.noBookings && !state.dates.length){
        setStatus("اختار تواريخ محجوزة أو فعّل خيار (لا يوجد أي حجز).", "تنبيه");
        return;
      }

      if(state.noBookings){
        $("confirmText").innerHTML =
          `قمت بكتابة أن مزرعتك <strong>لا يوجد لها أي حجوزات</strong> حالياً، هل هذا صحيح؟<br><br>
           <strong>كود المزرعة:</strong> ${state.code}<br>
           <strong>الحالة:</strong> لا يوجد حجوزات`;
      } else {
        const sorted = sortDates(state.dates).map(fmtISO);
        $("confirmText").innerHTML =
          `قمت بكتابة أن مزرعتك <strong>محجوزة</strong> في التواريخ المكتوبة أدناه، هل هذا صحيح؟<br><br>
           <strong>كود المزرعة:</strong> ${state.code}<br>
           <strong>التواريخ:</strong> ${sorted.join("، ")}`;
      }

      showPage(2);
    });

    $("confirmNo").addEventListener("click", async ()=>{
      try{
        const msg =
`Hayat Farms | طلب تغيير مواعيد الحجز
كود المزرعة: ${state.code || "-"}
الإجراء: الرجوع للتعديل قبل التأكيد
الوقت: ${new Date().toLocaleString("ar-EG")}`;
        await sendTelegram(msg);
      }catch(e){ console.warn(e); }
      showPage(1);
    });

    $("confirmYes").addEventListener("click", async ()=>{
      const msg = state.noBookings
        ? `Hayat Farms | تحديث الحجز (تأكيد)
كود المزرعة: ${state.code}
الحالة: لا يوجد حجوزات
الإجراء: تأكيد التحديث
الوقت: ${new Date().toLocaleString("ar-EG")}`
        : `Hayat Farms | تحديث الحجز (تأكيد)
كود المزرعة: ${state.code}
التواريخ المحجوزة: ${sortDates(state.dates).map(fmtISO).join("، ")}
الإجراء: تأكيد التحديث
الوقت: ${new Date().toLocaleString("ar-EG")}`;

      setStatus("جارٍ الإرسال...", "معالجة");
      try{
        await sendTelegram(msg);
        setStatus("تم إرسال الإشعار بنجاح.", "جاهز");
      }catch(e){
        setStatus("تم التأكيد محلياً، لكن فشل إرسال تيليجرام.", "تنبيه");
        console.warn(e);
      }
      showPage(3);
    });

    $("doneOk").addEventListener("click", ()=>{
      showPage(1);
      setStatus("تم.", "جاهز");
    });

    $("doneChange").addEventListener("click", async ()=>{
      try{
        const msg =
`Hayat Farms | تغيير بعد التأكيد
كود المزرعة: ${state.code || "-"}
الإجراء: فتح تعديل المواعيد بعد شاشة (تم)
الوقت: ${new Date().toLocaleString("ar-EG")}`;
        await sendTelegram(msg);
      }catch(e){ console.warn(e); }
      showPage(1);
      setStatus("رجعناك للتعديل.", "جاهز");
    });
  </script>
</body>
</html>
